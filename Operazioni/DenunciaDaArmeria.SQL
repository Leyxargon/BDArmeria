CREATE OR REPLACE PROCEDURE DenunciaDaArmeria (
	COD_PR	IN VARCHAR2,	-- CODICE PRODOTTO EQUIPAGGIAMENTO
	NUM_T	IN VARCHAR2,	-- NUMERO DEL TESSERINO DEL DIPENDENTE
	CF		IN VARCHAR2,	-- CODICE FISCALE DEL CLIENTE
	PREZZO	IN NUMBER		-- IMPORTO DELLA VENDITA
	)
AS
	TMP		NUMBER(1);		-- VARIABILE TEMPORANEA
	NUM_P	VARCHAR2(10);	-- NUMERO PROGRESSIVO VENDITA <PK>
	NPA		VARCHAR2(7);	-- NUMERO PORTO D'ARMI DEL CLIENTE
	COD_P	VARCHAR2(10);	-- CODICE PROGRESSIVO DENUNCIA <PK>
BEGIN
	
	-- GENERA NUMERO PROGRESSIVO VENDITA
	LOOP
		-- QUESTO CICLO ASSICURA L'UNIVOCITA' DEL NUMERO PROGRESSIVO
		NUM_P := SUBSTR(TO_CHAR(DBMS_RANDOM.VALUE(1111111111,999999999)),1,10);
		SELECT COUNT(*) INTO TMP
		FROM VENDITA
		WHERE NUM_PROG = NUM_P;
		EXIT WHEN TMP = 0;
	END LOOP;
	
	-- INSERISCE UNA VENDITA "GENERA SCONTRINO"
	INSERT INTO VENDITA (NUM_PROG,DATA_V,ORA_V,IMPORTO,NUM_TESSERINO) 
	VALUES (NUM_P, TO_DATE(SYSDATE,'DD-MON-YY'), TO_CHAR(SYSTIMESTAMP,'HH24:MI'), PREZZO, NUM_T);

	-- LEGGE IL PORTO D'ARMI DEL CLIENTE
	SELECT NUM_PORTO_ARMI INTO NPA
	FROM CLIENTE
	WHERE CF_CLI = CF;
	
	-- AGGIORNA LO STATO DELL'ARMA (NUOVO PROPRIETARIO)
	UPDATE EQUIPAGGIAMENTO
	SET NUM_PROG = NUM_P, NUM_PORTO_ARMI = NPA
	WHERE CODICE_PRODOTTO = COD_PR;
	
	-- EFFETTUA DENUNCIA (PRESSO COMMISSARIATO PIU VICINO)
	-- GENERA CODICE PROGRESSIVO DENUNCIA
	LOOP
		-- QUESTO CICLO ASSICURA L'UNIVOCITA' DEL CODICE PROGRESSIVO
		COD_P := SUBSTR(TO_CHAR(DBMS_RANDOM.VALUE(1111111111,999999999)),1,10);
		SELECT COUNT(*) INTO TMP
		FROM DENUNCIA
		WHERE CODICE_PROGRESSIVO = COD_P;
		EXIT WHEN TMP = 0;
	END LOOP;
	
	INSERT INTO DENUNCIA (CODICE_PROGRESSIVO,DATA_DENUNCIA,PEC,CF,CODICE_PRODOTTO)
	VALUES (COD_P, TO_DATE(SYSDATE,'DD-MON-YY'), 'comm.arenella.na@pecps.poliziadistato.it', CF, COD_PR);
	
	DBMS_OUTPUT.PUT_LINE('OPERAZIONE ESEGUITA');
	DBMS_OUTPUT.PUT_LINE('PRODOTTO: '||COD_PR);
	DBMS_OUTPUT.PUT_LINE('CLIENTE: '||CF||' ('||NPA||')');
	DBMS_OUTPUT.PUT_LINE('OPERATORE: '||NUM_T);
	DBMS_OUTPUT.PUT_LINE('IMPORTO: '||PREZZO);
	DBMS_OUTPUT.PUT_LINE('NUMERO DENUNCIA: '||COD_P);
END;
/